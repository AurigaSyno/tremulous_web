<!DOCTYPE html>
<html>
	<head>
		<title>Tremulous</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			
			html, body {
				height: 100%;
				padding: 0;
				margin: 0;
				background: #000;
			}

			body {
				position: relative;
			}

			h3, li {
				font-family: Arial, Helvetica, sans-serif;
				color: white;
			}

			.help-text {
				position: absolute;
				bottom: 20px;
				left: 20px;
				background: rgba(0, 0, 0, 0.7);
				padding: 15px;
				border-radius: 5px;
				pointer-events: none;
				z-index: 10;
			}

			.help-text h3 {
				margin-bottom: 10px;
				font-size: 14px;
			}

			.help-text ul {
				list-style: none;
				padding: 0;
			}

			.help-text li {
				font-size: 12px;
				margin: 5px 0;
			}

			#viewport-frame {
				position: absolute;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				overflow: hidden;
				background-image: url('/tremulous_action.png');
				background-repeat: no-repeat;
				background-position: center;
				background-size: 24em;
				transition: transform 0.3s ease;
			}

			#viewport-frame.rotated {
				transform: rotate(90deg);
			}
			
			#viewport-frame canvas {
				max-width: 100%;
				max-height: 100%;
				object-fit: contain;
			}

			#viewport-frame:focus {
				outline: none;
			}

			#viewport {
				background: #000;
				width: 100%;
				height: 100%;
			}

			#viewport-frame:-moz-full-screen,
			#viewport:-moz-full-screen {
				display: block;
				position: absolute;
				left: 0;
				top: 0;
				margin: 0;
				width: 100%;
				height: 100%;
			}

			#viewport-frame:-webkit-full-screen,
			#viewport:-webkit-full-screen {
				display: block;
				position: absolute;
				left: 0;
				top: 0;
				margin: 0;
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="viewport-frame"></div>
		<h3>Client Issues? Try Hard Resetting</h3>
		<ul>
			<li>Chrome: Shift+F5</li>
			<li>Firefox: Ctrl+F5</li>
			<li>Safari: Cmd+Option+R</li>
			<li>Edge: Ctrl+F5</li>
		</ul>
	</body>

	<script>
		function getQueryCommands() {
			var search = /([^&=]+)/g;
			var query  = window.location.search.substring(1);

			var args = [];

			var match;
			while (match = search.exec(query)) {
				var val = decodeURIComponent(match[1]);
				val = val.split(' ');
				val[0] = '+' + val[0];
				args.push.apply(args, val);
			}

			return args;
		}

		window.onload = function () {
			function resizeViewport() {
				if (!Module.canvas) {
					// ignore if the canvas hasn't yet initialized
					return;
				}
				if ((document['webkitFullScreenElement'] || document['webkitFullscreenElement'] ||
				         document['mozFullScreenElement'] || document['mozFullscreenElement'] ||
				         document['fullScreenElement'] || document['fullscreenElement'])) {
					// ignore resize events due to going fullscreen
					return;
				}
				Module.setCanvasSize(Module.viewport.offsetWidth, Module.viewport.offsetHeight);
			}

			// Handle viewport rotation based on orientation
			function handleOrientationChange() {
				var viewportFrame = document.getElementById('viewport-frame');
				var isPortrait = window.innerHeight > window.innerWidth;
				
				if (isPortrait) {
					viewportFrame.classList.remove('rotated');
				} else {
					viewportFrame.classList.add('rotated');
				}
			}

			// Listen for orientation changes
			window.addEventListener('orientationchange', handleOrientationChange);
			window.addEventListener('resize', handleOrientationChange);

			// Initial check
			handleOrientationChange();

			Module.viewport = document.getElementById('viewport-frame');
			Module.elementPointerLock = true;

			// Select random player name
			var randomName = '';
			if (player_names && player_names.length > 0) {
				var randomIndex = Math.floor(Math.random() * player_names.length);
				randomName = player_names[randomIndex];
			}

			// Build args array from config values
			var args = [];
			
			// Add fs_cdn from config (content server address), fallback to content variable
			if (clientConfig.fs_cdn && clientConfig.fs_cdn !== '') {
				args.push('+set', 'fs_cdn', clientConfig.fs_cdn);
			} else if (typeof content !== 'undefined' && content !== '') {
				args.push('+set', 'fs_cdn', content);
			}
			
			// Add default game settings
			args.push('+set', 'fs_game', clientConfig.fs_game || 'gpp');
			if (clientConfig.sv_master1 && clientConfig.sv_master1 !== '') {
				args.push('+set', 'sv_master1', clientConfig.sv_master1);
			} else {
				args.push('+set', 'sv_master1', 'master.tremulous.online');
			}
			
			// Get client.cfg from config
			if (clientConfig.client_cfg && clientConfig.client_cfg !== '') {
				args.push('+exec', clientConfig.client_cfg);
			}
			
			// Add connect option from config
			if (clientConfig.connect && clientConfig.connect !== '') {
				args.push('+connect', clientConfig.connect);
			}
			
			// Add random player name
			if (randomName !== '') {
				args.push('+set', 'name', randomName);
			}
			
			args.push.apply(args, getQueryCommands());
			Module.onRuntimeInitialized = function() {
				Module.callMain(args);
			}
		};
	</script>
	<script>
		// Inject client configuration from server
		var clientConfig = <%- typeof client !== 'undefined' ? JSON.stringify(client) : '{}' %>;
		// Inject player names from server
		var player_names = <%- typeof player_names !== 'undefined' ? JSON.stringify(player_names) : '[]' %>;
	</script>
	<script type="text/javascript" src="/tremulous.js"></script>
</html>
